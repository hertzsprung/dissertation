\section{Terrain following tracer advection}
\label{sec:wobblyTracerAdvection}

In the horizontal advection test, distortions in the BTF grid led to increased error.  In this test, the velocity field is aligned with the terrain following layers and results are compared between BTF and SnapCol grids.

\subsection{Specification}
The spatial domain, mountain profile, initial tracer profile and discretisation are the same as those in the horizontal tracer advection test (section~\ref{sec:advection}).  The velocity field, however, is defined as the non-divergent streamfunction $\Psi$ and extends from the top of the domain to the ground.  It is defined so that flow is everywhere tangential to BTF coordinate surfaces given by equation~\ref{eqn:theory:btf} such that
\begin{align}
	\Psi(x,z) &= H \frac{z - h}{H - h}
%
	\intertext{The horizontal and vertical components of velocity, $u$ and $w$ are then given by}
%
	u &= \frac{\partial \Psi}{\partial z} \quad,\quad  w = -\frac{\partial \Psi}{\partial x}
%
	\intertext{Hence, for the mountain profile given in equation~\ref{eqn:advection:schaerCos} we find}
%
	u &= \frac{H}{H - h} \quad,\quad w = H \frac{\partial h}{\partial x} \frac{H - z}{\left( H - h \right)^2} \label{eqn:wobblyTracerAdvection:velocity} \\
	\frac{\partial h}{\partial x} &= - h_0 \pi \left[ 
		\frac{1}{\lambda} \cos^2 \left( \frac{\pi x}{2a} \right) \sin \left( \frac{2 \pi x}{\lambda} \right) +
		\frac{1}{2a} \cos^2 \left( \frac{\pi x}{\lambda} \right) \sin \left( \frac{\pi x}{a} \right)
	\right]
\end{align}
The resulting velocity field is shown in figure~\ref{fig:wobblyTracer:u}.

\begin{figure}
	\centering
	\includegraphics[width=2.0in,angle=270]{openfoam/cases/wobblyTracerAdvection/btf/schaerCos/cubicUpwindCPCFit/0/U.eps}
	\caption{Terrain following velocity field with flow everywhere tangential to BTF coordinate surfaces.  Outline of BTF grid shown in grey.  Only the lowest \SI{15}{\kilo\meter} of the central \SI{60}{\kilo\meter} is shown.  The entire domain is \SI{300}{\kilo\meter} wide and \SI{25}{\kilo\meter} high.}
	\label{fig:wobblyTracer:u}
\end{figure}

\subsection{Results}

\begin{figure}
	\captionsetup[subfigure]{position=b}
	\centering
	\subcaptionbox{BTF \label{fig:wobblyTracerAdvection:btf}}[0.49\textwidth]{\input{wobblyTracerAdvection-btf-schaerCos-cubicUpwindCPCFit-contour-plot}}
	\hfill
	\subcaptionbox{SnapCol \label{fig:wobblyTracerAdvection:snapCol}}[0.49\textwidth]{\input{wobblyTracerAdvection-snapCol-schaerCos-cubicUpwindCPCFit-contour-plot}}
%
	\caption{Advected tracer contours in a terrain following velocity field at $t = \SI{0}{\second}$, \SI{5000}{\second} and \SI{10000}{\second}.  Contour intervals are every 0.1.}
\end{figure}

Errors on the BTF grid are reduced compared to those in the horizontal tracer advection test: artefacts above the mountain, as seen in figure~\ref{fig:advection:cubicUpwind:btf}, are no longer present in figure~\ref{fig:wobblyTracerAdvection:btf}, and the $\ell^2$ error norm is reduced from \input{openfoam/cases/advection/btf/schaerCos/cubicUpwindCPCFit/l2error.txt}\unskip to \input{openfoam/cases/wobblyTracerAdvection/btf/schaerCos/cubicUpwindCPCFit/l2error.txt}\unskip.  Despite the large distortions due to the oscillating velocity field above the mountain, tracer shape is preserved having cleared the mountain at $t = \SI{10000}{\second}$.

In contrast, the tracer suffers from significant diffusion on the SnapCol grid as evidenced by the fewer, wider contours in figure~\ref{fig:wobblyTracerAdvection:snapCol}.  The error on the SnapCol grid is larger than that for any other tracer advection.  $\ell^2$ error norms are compared with those for horizontal advection in table~\ref{tab:advection:errors}.

\begin{table}
\centering
\begin{tabular}{ r @{\hspace{2em}} l l}
\toprule
		& Horizontal advection & Terrain following advection \\ \midrule
BTF		& \input{openfoam/cases/advection/btf/schaerCos/cubicUpwindCPCFit/l2error.txt}		& \input{openfoam/cases/wobblyTracerAdvection/btf/schaerCos/cubicUpwindCPCFit/l2error.txt} \\
SLEVE		& \input{openfoam/cases/advection/sleve/schaerCos/cubicUpwindCPCFit/l2error.txt}	& --- \\
SnapCol		& \input{openfoam/cases/advection/snapCol/schaerCos/cubicUpwindCPCFit/l2error.txt}	& \input{openfoam/cases/wobblyTracerAdvection/snapCol/schaerCos/cubicUpwindCPCFit/l2error.txt} \\
Regular grid	& \input{openfoam/cases/advection/noOrography/cubicUpwindCPCFit/l2error.txt}		& --- \\ \bottomrule
\end{tabular}
%
\caption{$\ell^2$ error norms for the horizontal and terrain following tracer advection tests at $t = \SI{10000}{\second}$.  Horizontal tracer advection is discussed in section~\ref{sec:advection}, terrain following advection in section~\ref{sec:wobblyTracerAdvection}.}
\label{tab:advection:errors}
\end{table}
