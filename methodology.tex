\chapter{Methodology}
\label{sec:method}

Here, we describe the construction of BTF and SLEVE terrain following grids and a cut cell style grid.  A finite volume model of the fully-compressible Euler equations from \textcite{weller-shahrokhi2014} is discussed.  In the following chapter, five tests are presented in which the model is run on the terrain following and cut cell grids.  Finally, we give details of energy measures and the Courant--Friedrich--Lewy criterion, which constraints the model timestep.  These metrics are used to evaluate model performance in chapter~\ref{sec:results}.

\section{Grid construction}
\label{sec:method:grid}

A combination of standard and custom OpenFOAM utilities were used to create three grids: BTF, SLEVE, and a cut cell style grid.  OpenFOAM grids comprise a set of cells connected by shared faces.  A face is composed from a list of points that form the face vertices.
OpenFOAM uses a three dimensional Cartesian coordinate system.  Since all tests presented here are two dimensional $x-z$ plane, empty boundary conditions are used on the front and back faces to ensure that no solutions are required in the $y$ direction.

Two dimensional, regular Cartesian grids were created using the OpenFOAM utility, \shellcmd{blockMesh}.  A custom utility was used to modify these orthogonal grids by adjusting the height of points to create terrain following grids.

Most implementations of terrain following layers use a coordinate system that makes the domain rectangular, but introduces metric terms into the equations of motion (more detail was presented in section~\ref{sec:theory:coord-transform}).  Instead, the model presented here uses Cartesian coordinates and unstructured grids.  By doing so, results from the same model can be compared between terrain following and cut cell grids without modifying the equation set or discretisation.

\begin{figure}
\centerfloat
\includegraphics[height=2.8in,angle=270]{mesh-snapCol-schaerExp-resting.eps}
\caption{A `SnapCol' grid, \SI{20}{\kilo\meter} wide and \SI{2}{\kilo\meter} high, created by intersecting the terrain surface with a regular grid as described in section~\ref{sec:method:grid}.  Note that, unlike a true cut cell grid, some small cells have faces at $z = \SI{500}{\meter}$ that are not entirely horizontal.}
\label{fig:method:cut-cell}
\end{figure}

At the time of writing, there is no OpenFOAM utility to generate cut cell grids\footnote{An enhancement request was filed in 2013 to add support for Cartesian cut cells to OpenFOAM, see \url{http://www.openfoam.org/mantisbt/view.php?id=1083}}.  Instead, the OpenFOAM utility \shellcmd{snappyHexMesh} was used to create a grid that approximates the cut cell method.  First, a custom utility was used to move points beneath the surface up to the surface creating small cells near mountain peaks.  Second, a description of the surface was taken from any of the terrain following grids and \shellcmd{snappyHexMesh} was used to intersect the surface with the grid.  The tool removes cells whose centres are below the surface.  An example of the resulting grid is shown in figure~\ref{fig:method:cut-cell}.

The grid is not strictly a cut cell mesh because, when \shellcmd{snappyHexMesh} moves points along the surface according to its heuristics, some points are moved horizontally.  It has not been possible to correct this issue for this project.  This grid is referred to as the `SnapCol' grid throughout this project.


\section{Discretisation of Euler equations}
\label{sec:method:discretisation}

The fully-compressible Euler equations used in the resting atmosphere test (section~\ref{sec:resting}) and gravity waves test (section~\ref{sec:gw}) are specified as
\begin{subequations}
\begin{align}
& \text{Momentum} & \frac{\partial \rho \vect{u}}{\partial t} + \del \cdot \rho \vect{u} \vect{u} &= \rho \vect{g} - c_p \rho \theta \del \exner \label{eqn:method:momentum} \\
%
& \text{Continuity} & \frac{\partial \rho}{\partial t} + \del \cdot \rho \vect{u} &= 0 \label{eqn:method:continuity} \\
%
& \text{Potential temperature} & \frac{\partial \rho \theta}{\partial t} + \del \cdot \rho \vect{u} \theta &= 0 \\
%
& \text{Equation of state} & \exner^{(1 - \kappa / \kappa)} &= \frac{R \rho \theta}{p_0}
\end{align}
\end{subequations}
where $\rho$ is the density and $\vect{g}$ is gravitational acceleration.  Other variables are as defined in section~\ref{sec:theory:staggering}.

Here, we outline the placement of prognostic variables, pressure gradient discretisation, and the advection scheme.  Further details of the discretisation are given by \textcite{weller-shahrokhi2014}.

\begin{figure}
\captionsetup[subfigure]{position=b}
\centering
\subcaptionbox{Vertical cross section of geometry}[0.48\textwidth]{\input{geometry}}
\hfill
\subcaptionbox{Placement of prognostic variables \label{fig:method:placement:variables}}[0.48\textwidth]{\input{variable-placement}}
\caption{Geometric placement of prognostic variables in two dimensions.  Adapted from \textcite{weller-shahrokhi2014}.}
\label{fig:method:placement}
\end{figure}

To solve the continuity equation (equation~\ref{eqn:method:continuity}), in section~\ref{sec:theory:fv} we found that we must calculate the flux across all cell faces (see equation~\ref{eqn:theory:discrete-continuity}).  To do this, we first find the mass flux component $V_f$ in the direction between cell centres such that
\begin{align}
V_f &= \rho \vect{u} \cdot \vect{d}_f
%
\intertext{where $\vect{d}_f$ is the vector between the centres of the two cells who share the face $f$.  Second, we use the H operator given in \textcite{weller-shahrokhi2014} to find the mass flux normal to the surface, $U_f$, that is}
%
U &= HV
\end{align}
where $U_f = \rho \vect{u} \cdot \vect{S}_f$, and $\vect{S}_f$ is normal to the face $f$ having a magnitude equal to the face area.  \textcite{thuburn-cotter2012} recommend the use of $V$ instead of $U$ as the prognostic variable to obtain mimetic properties including a curl-free pressure gradient.  The geometry just described is summarised in figure~\ref{fig:method:placement}.

As shown in figure~\ref{fig:method:placement:variables}, the discretisation uses a Lorenz vertical staggering, as described in section~\ref{sec:theory:staggering}, with $\theta$ stored at the cell centre.

The Exner gradient at a face $f$ in the direction between cell centres, $\del_d \exner$, is calculated from the Exner value of the two cells who share the face \autocite{weller-shahrokhi2014}
\begin{align}
\del_d \exner = \frac{1}{| \vect{d}_f |} \sum_{c \in\: f} - n_f \exner_c
%
\intertext{where $n_f$ corrects for the face orientation so that}
%
n_f =
\begin{cases}
	1  & \text{if $\vect{S}_f$ points away from the cell} \\
	-1 & \text{if $\vect{S}_f$ points toward the cell}
\end{cases}
\end{align}

\begin{figure}
\centering
\input{cubicUpwind-stencil}
\caption{Two-dimensional cubic upwind stencil used in advecting momentum and potential temperature.  A face value $\Psi_F$ is interpolated from cell values, $\Psi_c$, denoted by grey dots.  Adapted from \textcite{weller-shahrokhi2014}.}
\label{fig:method:cubicUpwind}
\end{figure}

Momentum and potential temperature are advected using an upwind-biased cubic interpolation.  A multi-dimensional cubic function is used whose coefficients are found using a least-squares fit with cell data in the stencil.  These coefficients are used to weight the cell values within the stencil, and the weighted sum is used to calculate $\Psi_F$.  A two-dimensional stencil is shown in figure~\ref{fig:method:cubicUpwind}.

\section{Energy measures}
\label{sec:method:energy}

Energy conservation is desirable in the discretisation of the Euler equations.  In the resting atmosphere test detailed in section~\ref{sec:resting}, energy is conserved in the analytic solution, but not in all numerical approximations.  The normalised energy change $\Delta E$ at time $t$ is found by comparing with the initial energy measure, hence
\begin{align}
\Delta E(t) &= \frac{E(t) - E(t = \SI{0}{\second})}{E(t = \SI{0}{\second})}
\end{align}
Three energy measures are considered, where the volume integral of some field $\varphi$ is the volume-weighted sum given by
\begin{align}
\int_V \varphi \diff{V} &= \frac{\sum_c \varphi_c V_c}{\sum_c V_c}
\end{align}
First, kinetic energy $E_K$ is calculated as \autocite{thuburn2014}
\begin{align}
E_K(t) &= \int_V \frac{1}{4} \sum_{f \in \: c} \frac{\left( \vect{u} \cdot \vect{S}_f \right) \left( \vect{u} \cdot \vect{d}_f \right)}{V_c} \diff{V}
%
\intertext{Second, potential energy $E_P$ is}
%
E_P(t) &= - \int_V \rho \vect{g} \cdot \vect{x}_c \diff{V}
%
\intertext{where $\vect{x}_c$ is the position vector of the centre of cell $c$.  Third, the internal energy $E_I$ is \autocite{curry-webster1998}}
%
E_I(t) &= \int_V \rho T c_v \diff{V}\\
       &= \int_V \rho T \left( \frac{p_0}{p} \frac{p}{p_0} \right)^{R/c_p} c_v \diff{V} \\
       &= \int_V \rho \theta \Pi c_v \diff{V}
\end{align}
where $c_v$ the heat capacity of dry air at constant volume, assuming an perfect gas with constant $c_v$.

\section{Courant--Friedrichs--Lewy criterion}
The Courant--Friedrichs--Lewy (CFL) criterion is a necessary condition for numerical stability (though it is not always, by itself, a sufficient condition).  For an explicit advection scheme, it constrains the timestep as a function of wind speed and cell volume.  This is especially relevant for the small cells produced by the piecewise linear shaving technique described in section~\ref{sec:theory:shaving}.

The CFL criterion states that the numerical domain of dependence must contain the true domain of dependence for the scheme to be convergent \autocite{leveque2002}.

On a two-dimensional unstructured grid, the Courant number for cell $c$ is \autocite{weller-shahrokhi2014}
\begin{align}
\courant_c = \frac{\Delta t}{2 V_c} \sum_{f \in\: c} \vect{u} \cdot \vect{S}_f \label{eqn:method:courant}
\end{align}
so that the CFL criterion is $\courant_c \leq 1\:\forall\:c$.

