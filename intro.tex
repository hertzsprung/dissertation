\chapter{Introduction}

Orography has significant effects on local weather, creating strong downslope winds and enhancing local precipitation \autocite{barry2008}.  Terrain also affects global circulation by exerting low-level drag \autocite{lott-miller1997} and transporting momentum via gravity waves \autocite{mcfarlane1987}.

To capture these effects, numerical weather prediction (NWP) models must solve the equations of motion on a grid that represents the orography.
There are two main approaches: transform the coordinates so that the domain becomes rectangular, or use Cartesian coordinates and apply special treatment to the lower boundary \autocite{galchen-somerville1975}.

Terrain following (TF) coordinates are in widespread use in operational models.  In this transformed coordinate system the terrain's influence decays with height: the bottommost layers follow the underlying surface closely while the uppermost layers are flat.

A variety of vertical coordinates can be used in TF models.  The equations of motion with the hydrostatic approximation are simplified by using pressure coordinates \autocite{eliassen1949}.  However, in the presence of orography, the lower boundary condition becomes complicated because surfaces of constant pressure intersect the terrain.  This motivated \textcite{phillips1957} to create the sigma coordinate in which pressure is normalised such that $\sigma$ ranges between zero at the top of the domain, and one at the surface.
Most hydrostatic models use normalised pressure coordinates.  With some exceptions, such as \textcite{xue-thorpe1991}, nonhydrostatic models use height-based coordinates \autocite{steppeler2003}.
\TODOsidenote{there are others such as isentropic (briefly mentioned in Mesinger1988), isopycnal etc... don't know if they're worth mentioning}

It is well-known that TF coordinates perform badly in the presence of steep orography.  As spatial resolution in NWP models increases, gradients in terrain become steeper.  This leads to greater errors in the horizontal pressure gradient which results in spurious winds \autocite{dempsey-davis1998}.  \TODOsidenote{I'll explain how the spurious winds happens in a later section}  Much work has been done to reduce error associated with TF coordinates: firstly, by smoothing the effects of terrain with height and, secondly, by improving the accuracy of the horizontal pressure gradient itself.

\textcite{galchen-somerville1975} proposed a basic terrain following (BTF) coordinate system in which the terrain's influence decays linearly with height but disappears only at the top of the domain.  \TODOsidenote{say what's bad about BTF}  \TODOsidenote{I'll give the mathematical definition of BTF in a later section}

The hybrid terrain following (HTF) coordinates of \textcite{simmons-burridge1981} improve upon BTF coordinates by allowing the vertical decay profile can be controlled.  By choosing a suitable profile, terrain influence decays more rapidly than BTF to produce surfaces of constant height aloft \autocite{klemp2011}.

The coordinate system can be further refined by decaying small-scale features more rapidly than large-scale features to produce smooth coordinate surfaces in the middle and top of the domain.  \textcite{schaer2002} achieved this with smooth level vertical (SLEVE) coordinates in which terrain height is split into small-scale and large-scale components, each having different exponential decay profiles.  \TODOsidenote{if I'm going to include results from SLEVE grid, I'll have to say more about how it works}  \textcite{klemp2011} took an alternative approach, using a multipass smoothing operator, and found that errors were reduced still further compared to SLEVE.

Another way of reducing error is to improve the accuracy of the horizontal pressure gradient discretisation.  \textcite{mahrer1984} proposed a discretisation where two pressure values at the same geometric height are interpolated from surrounding points.  From these values, a truly horizontal pressure gradient can be calculated without introducing metric terms.  Recent studies have found that variations of Mahrer's technique reduce spurious circulations \parencites{dempsey-davis1998}{klemp2011}{zaengl2012}.  \TODOsidenote{I'll go into more detail on pressure gradients in a subsequent section.}

\TODOsidenote{mention use of perturbation pressure in NH models? (although problem is not eliminated, only less severe (Dempsey \& Davis 98))}

Despite their associated numerical errors, TF coordinates are attractive because they simplify the lower boundary condition, their rectangular structure is simple to process by computer \autocite{schaer2002}, and cell sizes remain almost constant \autocite{jebens2011}.

In contrast, Cartesian coordinate grids have cells of varying sizes immediately above the ground.  The step-mountain coordinate proposed by \textcite{mesinger1988} removes cells that are intersected by the terrain so creating steps over the surface.  \TODOsidenote{is this really cartesian (Good et al 2013 suggest it is) or is it a coord transform (seems to be according to Mesinger1988)?}  \textcite{gallus-klemp2000} found that lee slope winds are too weak over smooth orography, but this study did not examine performance over steep terrain.  In contrast, \textcite{mesinger2004} compared results from three operational NCEP models that suggested the step-coordinate model was more skillful than the TF coordinate models in forecasting precipitation over the mountainous western United States.

\TODO{worth mentioning partial step next?}

The cut cell (or `shaved cell')  method is another alternative to terrain following coordinates.  Here, the surface terrain is intersected with a regular Cartesian grid such that cells are cut where they intersect with the ground.   The primary difficulty is with numerical stability and reduced model efficiency associated with small cells. \TODOsidenote{another disadvantage: boundary layer parameterisations (Zaengl 2012)}

A variety of solutions to the `small cell problem' have been proposed.  In \textcite{yamazaki-satomura2010}, small cells are combined with horizontally or vertically adjacent cells.  \TODOsidenote{should I discuss result of each of these techniques?} \TODOsidenote{Good et al 2013 say that Y\&S2010 found you could increase the timestep tenfold.  But I see no mention of this in the paper}  \textcite{steppeler2002} use a `thin-wall' approximation to increase the computational volume of small cells without altering the terrain.  Conceptually, each cell partially or completely below the mountain is filled with air and surrounded by a thin wall.  Where a cell is cut by the terrain, the computational volume is equal to that of an uncut cell.  \textcite{jebens2011} avoid the timestep restriction associated with explicit schemes by using an implicit method for cut cells and a semi-explicit method elsewhere.

Several studies found that cut cells produce more accurate results when compared to TF coordinates.  Spurious winds seen in TF coordinates are not present and errors do not increase with horizontal resolution \autocite{good2013}.  Cut cells have been found to be more accurate with steep terrain in several experiments \parencites{good2013}{yamazaki-satomura2010}.  A comparison of TF and cut-cells using real initial data by \textcite{steppeler2006} found that precipitation patterns, temperature and wind fields were forecast more accurately in the cut-cell model, and the weak lee slope winds found by \textcite{gallus-klemp2000} in the step-mountain coordinate model were not present.  
\TODOsidenote{look at Fast 2003 and refs therein for more cut-cell goodness}

Other representations of terrain have been developed using unstructured grids.  They are able to represent the boundary accurately but, because they require a more complex data representation compared to structured grids, they can be difficult to partition for parallel computation \autocite{steppeler2003}.  More complex discretisations are required to maintain accuracy because the mesh is not aligned with the dominant vertical force of gravity \autocite{rosatti2005}, just as horizontal pressure gradients are difficult to calculate in TF coordinates.  \TODOsidenote{comparing horizontal pressure gradient with vertical force of gravity is my own idea}

\TODO{Worth talking about nested grids?  e.g. Almgren 1998}

\TODO{talk about the advantages of adaptive grids.  Steppeler 2003 says a bit, Blaise 2012 says they can capture range of spatial scales while improving computational efficiency.  Can I find an example in literature of adaptive meshing to follow the flow? Almgren 1998 looks interesting, for example.} 

This project aims to compare the accuracy of TF and cut-cell style grids in a variety of two-dimensional test cases.  Simulations are performed using the OpenFOAM CFD library \autocite{openfoam} with a discretisation of the fully compressible Euler equations from \textcite{weller-shahrokhi2014}.  \TODO{more on this when I've written the rest!}

\TODO{\textbf{outline of the remaining chapters}}

\chapter{Theoretical basis}
\TODO{feels to me like the sections that follow all belong in their own chapter}

\TODO{\textbf{finite volume technique} (adcroft 1997 has some nice stuff)  relevant to cut cells and, more generally, because all our work is in cartesian coord sys and OpenFOAM is all FV}

\TODO{\textbf{CFL criterion}.  relevant to understand timestep constraints on small cells}

\section{Coordinate transformations}
\TODOsidenote{I could merge this with pressure gradient error section below because this will help explain the presence of the metric term (see Dempsey \& David 1998)}
Consider the two-dimensional Cartesian coordinates $(x, z)$ and a transformed coordinate $Z$ which is a monotonic function of $z$.  That is, $Z = Z(x, z)$ and $z = Z^{-1}$.  A scalar field $\varphi$ can be expressed in Cartesian coordinates as $\varphi(x, z)$ or in transformed coordinates as $\varphi(x, z(x, Z))$. \TODOsidenote{z doesn't explicitly depend on x, only implicitly through Z.  but it makes the multivariable chain rule easier to construct}
Hence the vertical derivative of $\varphi$ can be found by using the chain rule
\begin{align}
\frac{\partial \varphi}{\partial Z} =
  \frac{\partial \varphi}{\partial z}
  \frac{\partial z}{\partial Z}
\intertext{and rearranging to give}
\frac{\partial \varphi}{\partial z} =
  \frac{\partial \varphi}{\partial Z}
  \frac{\partial Z}{\partial z}
\end{align}

The multivariable chain rule is needed to find the horizontal derivative.  Given a $m \times n$ Jacobi rotation matrix
\begin{align}
\frac{\partial y_i}{\partial x_j} = 
\begin{bmatrix}
  \dfrac{\partial y_1}{\partial x_1}	& \dfrac{\partial y_1}{\partial x_2} &	\cdots &	\dfrac{\partial y_1}{\partial x_n} \\
  \vdots				& \vdots &				\ddots &	\vdots \\
  \dfrac{\partial y_m}{\partial x_1}	& \dfrac{\partial y_m}{\partial x_2} &	\cdots &	\dfrac{\partial y_m}{\partial x_n}
\end{bmatrix}
%
\intertext{we can express the chain rule as}
%
\frac{\partial y_i}{\partial x_j} = \frac{\partial y_i}{\partial u_i} \frac{\partial u_i}{\partial x_j}
%
\intertext{Applying this to $\varphi$ we find}
%
\begin{bmatrix}
\frac{\partial \varphi}{\partial x}  &  \frac{\partial \varphi}{\partial Z}
\end{bmatrix}
=
\begin{bmatrix}
\frac{\partial \varphi}{\partial x}  &  \frac{\partial \varphi}{\partial z}
\end{bmatrix}
\begin{bmatrix}
\frac{\partial x}{\partial x} & 	\frac{\partial x}{\partial Z} \\
\frac{\partial z}{\partial x} &	\frac{\partial z}{\partial Z}
\end{bmatrix}
%
\intertext{therefore the horizontal...}
%
\left. \frac{\partial \varphi}{\partial x} \right|_Z =
  \left. \frac{\partial \varphi}{\partial x} \right|_z +
         \frac{\partial \varphi}{\partial z}
  \left. \frac{\partial z}{\partial x} \right|_Z
  \label{eq:coord:horizontal}
\end{align}
where the subscript by the vertical bar denotes the variable that is held constant. \TODOsidenote{This came from \href{http://ocw.mit.edu/courses/earth-atmospheric-and-planetary-sciences/12-950-atmospheric-and-oceanic-modeling-spring-2004/lecture-notes/lec25.pdf}{MIT lecture notes} -- I'm not sure if I need to cite them or what.  See also \href{http://math.stackexchange.com/q/857435/89878}{my StackExchange question}}

\TODO{show what happens to hydrostatic balance equation in transformed coordinates}


\TODO{\textbf{pressure gradient errors}.  explains the main problem with TF coords, motivates alternatives.  this will build upon the previous section (talk about pressure gradient calculated with metric terms versus truly horizontal)  Mesinger 1988 says this ISN'T a truncation error, others say it is (Mahrer 1984).  review this, maybe?  need to explain exner function at some point, too}

\TODO{\textbf{grids in detail}.  BTF, SLEVE (are we going to this in all our test cases?), cut cell (as set out by rosatti 2005, klein 2009 etc)}
