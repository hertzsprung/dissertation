\chapter{Theoretical basis}

\section{Coordinate transformations}
\label{sec:theory:coord-transform}

Consider the two-dimensional cartesian coordinates $(x, z)$ and transformed coordinates $(x, \trans{z})$ which must be a monotonic function of $z$ so that the transformation is invertible.

A scalar field $\varphi$ can be expressed in transformedcoordinates as $\varphi(x, \trans{z})$ or in cartesian coordinates as $\varphi(x, \trans{z}(x, z))$.
Hence the vertical derivative of $\varphi$ can be found by using the chain rule \autocite{mit2004}
\begin{align}
  \frac{\partial \varphi}{\partial z} =
  \frac{\partial \varphi}{\partial \trans{z}}
  \frac{\partial \trans{z}}{\partial z}
\end{align}

The multivariable chain rule is needed to find the horizontal derivative.  Given a $m \times n$ Jacobi rotation matrix \textcite{kaplan?}
\begin{align}
\frac{\partial y_i}{\partial x_j} = 
\begin{bmatrix}
  \dfrac{\partial y_1}{\partial x_1}	& \dfrac{\partial y_1}{\partial x_2} &	\cdots &	\dfrac{\partial y_1}{\partial x_n} \\
  \vdots				& \vdots &				\ddots &	\vdots \\
  \dfrac{\partial y_m}{\partial x_1}	& \dfrac{\partial y_m}{\partial x_2} &	\cdots &	\dfrac{\partial y_m}{\partial x_n}
\end{bmatrix}
%
\intertext{and similarly for $\partial y_i / \partial u_i$ and $\partial u_i / \partial x_j$, \TODO{check these subscripts in Kaplan!} then we can express the chain rule as}
%
\frac{\partial y_i}{\partial x_j} = \frac{\partial y_i}{\partial u_i} \frac{\partial u_i}{\partial x_j}
%
\intertext{Applying this to $\varphi$ we find}
%
\begin{bmatrix}
	\frac{\partial \varphi}{\partial x}  &  \frac{\partial \varphi}{\partial z}
\end{bmatrix}
=
\begin{bmatrix}
	\frac{\partial \varphi}{\partial x}  &  \frac{\partial \varphi}{\partial \trans{z}}
\end{bmatrix}
\begin{bmatrix}
	\frac{\partial x}{\partial x} & 	\frac{\partial x}{\partial z} \\
	\frac{\partial \trans{z}}{\partial x} &	\frac{\partial \trans{z}}{\partial z}
\end{bmatrix} \label{eqn:theory:transform-matrix}
%
\intertext{and the horizontal component of equation~\ref{eqn:theory:transform-matrix} is then}
%
\left. \frac{\partial \varphi}{\partial x} \right|_z =
\left. \frac{\partial \varphi}{\partial x} \right|_\trans{z} +
	\frac{\partial \varphi}{\partial \trans{z}}
	\left. \frac{\partial \trans{z}}{\partial x} \right|_z \label{eq:theory:coord-trans}
\end{align}
where the subscript by the vertical bar denotes the variable that is held constant.  \TODOsidenote{This came from \href{http://ocw.mit.edu/courses/earth-atmospheric-and-planetary-sciences/12-950-atmospheric-and-oceanic-modeling-spring-2004/lecture-notes/lec25.pdf}{MIT lecture notes} -- I'm not sure if I need to cite them or what.}

In a two-dimensional terrain-following coordinate transform, there is the added requirement that the transformed domain be rectangular.  This can be satisfied by imposing boundary conditions \autocite{schaer2002}
\begin{align}
	\trans{z}(x, \surface(x)) = 0 \quad,\quad \trans{z}(x, H) = H
\end{align}
where $H$ is the height of the domain and $h(x)$ is the height of the terrain surface.

\section{Horizontal pressure gradient}
\begin{figure}
	\centering
	\input{pressure-grad}
	\caption{Geometry of a first-order horizontal pressure gradient discretisation in a transformed coordinate.  Adapted from \textcite{mahrer1984}.}
	\label{fig:theory:pressure-error}
\end{figure}

It follows from equation~\ref{eq:theory:coord-trans} that, in TF coordinates, the horizontal gradient of pressure $p$ is \autocite{mahrer1984}
\begin{align}
	\left. \frac{\partial p}{\partial x} \right|_z = 
	\left. \frac{\partial p}{\partial x} \right|_\trans{z} + 
	\left. \frac{\partial \trans{z}}{\partial x} \right|_z
	\frac{\partial p}{\partial \trans{z}}
\end{align}
The first term on the right hand side is the change in pressure along the TF coordinate surface, and the second term corrects for the vertical variation in the first.  These terms tend to be large and of opposite sign over steep terrain, and a discretisation must be at least first order accurate so that the difference between the hydrostatic components of the two terms converges to zero \autocite{gary1973}.  Errors in the horizontal pressure gradient are associated with horizontal acceleration by the momentum equation, and have been shown to generate spurious winds \parencites{klemp2003}{klemp2011}.

\section{Grids}
\subsection{Basic terrain following (BTF)}
\label{sec:theory:btf}

The basic terrain following (BTF) coordinates of \textcite{galchen-somerville1975} are defined as
\begin{align}
	\trans{z} &= H \frac{z - \surface}{H - \surface}
%
\intertext{or}
%
	z &= \left( H - \surface \right) \frac{\trans{z}}{H} + \surface
\end{align}
where, in two dimensions, $z(x, \trans{z})$ is the height of the coordinate surface at level $\trans{z}$, $H$ is the height of the domain, and $\surface(x)$ is the height of the terrain surface.

The sigma coordinate transform is equivalent to the BTF coordinate transform since they both decay linearly.  However, since they decay with pressure rather than height, sigma coordinates also vary with horizontal variations in pressure.

\subsection{Smooth level vertical (SLEVE)}
\label{sec:theory:sleve}
Unlike most TF coordinates in which the vertical transformation depends only on terrain height, \textcite{schaer2002} describes a coordinate system in which vertical decay is scale-dependent.  Terrain height is split into a large-scale component $\surface_1$ and a small-scale component $\surface_2$ such that $\surface = \surface_1 + \surface_2$.  The transformation is defined as
\begin{align}
	z &= \trans{z} + \surface_1 b_1 + \surface_2 b_2
%
\intertext{with the vertical decay functions are given by}
%
	b_i &= \frac{\sinh \left( \left( H - \trans{z} \right) / s_i \right)}{\sinh \left( H / s_i \right)}
\end{align}
where $s_1$ and $s_2$ are the scale heights of large-scale and small-scale terrain respectively.

\textcite{leuenberger2010} generalised the SLEVE transformation in order to increase cell thickness in the layers nearest the ground.  An exponent $n$ is introduced so that the generalised decay functions become
\begin{align}
	b_i &= \frac{\sinh \left( \left( H / s_i \right)^n - \left( \trans{z} / s_i \right)^n \right)}{\sinh \left( H / s_i \right)^n}
\end{align}
where the optimal exponent value was found to be $n = 1.35$.

\subsection{Cut cell}
\TODO{as set out by rosatti 2005, klein 2009 etc}

The cut cell method intersects the surface with a regular cartesian grid.  This leads to cells that are entirely above the surface, entirely below it, and those which intersect with the ground.  Those cells which intersect the ground have, in two dimensions, a triangular, trapezoidal or pentagonal shape \autocite{rosatti2005}.

\section{Finite volume method}
\label{sec:theory:fv}

The finite volume method is a discretisation technique that represents the spatial domain as a grid of cells.  A volumetric scalar field $\varphi$ is then discretised by modelling the average value in each cell located at its centre.  At each timestep, cell averages are updated by considering the flux $\vect{F}$ across the faces of the cell surface.  In atmospheric modelling, $\vect{F}$ is typically the advective flux $\vect{u} \varphi$ where $\vect{u}$ is the velocity field.

The notation used in this project for the representation discrete variables follows \textcite{weller-shahrokhi2014}.  A cell average of $\varphi$ is written as $\varphi_c$, where $c$ denotes a cell.  A volumetric vector field $\psi$ located at a face is written as $\psi_f$, where $f$ denotes a cell face.  An interpolation of cell centre averages of $\varphi$ onto a face $f$ is written as $\varphi_F$.  $f \in \: c$ represents the faces of a cell.  $c \in \: f$ represents the cells $c$ that share a face $f$.

To develop the finite volume method, we start by considering the conservation of $\varphi$
\begin{align}
	\frac{\partial \varphi}{\partial t} + \del \cdot \left( \vect{u} \varphi \right) = 0
%
\intertext{Taking the volume integral over a cell $c$ with volume $V_c$ we find}
%
	\int_{V_c} \frac{\partial \varphi}{\partial t} \diff V + \int_{V_c} \del \cdot \left( \vect{u} \varphi \right) \diff V &= 0
%
\intertext{Integrating the first term gives the cell average $\varphi_c$ and applying the divergence theorem to the second term gives a surface integral, hence}
%
	V_c \frac{\partial \varphi_c}{\partial t} + \int_{S_c} \varphi \vect{u} \cdot \nunit \diff S &= 0
%
\intertext{where $S_c$ is the cell surface area and $\nunit$ is the unit vector that is outward normal to the surface.  Dividing by the cell volume and, for a cell with a finite number of surfaces, this becomes}
%
	\frac{\partial \varphi_c}{\partial t} + \frac{1}{V_c} \sum_{f \in \: c} \varphi_F \vect{u}_f \cdot \nunit S_f &= 0 \label{eqn:theory:discrete-continuity}
\end{align}
where $S_f$ is the surface area of face $f$, and $\varphi_F$ is the interpolated value of $\varphi$ at the face.  This interpolation of cell averages onto faces is a significant source of truncation error in finite volume systems \autocite{adcroft1997}.

The finite volume method leads to a staggering of variables with fluxes at cell faces similar to an Arakawa C grid.  Because cell averages are modified only through surface fluxes, a quantity of $\varphi$ the fluxes out of one cell must flux into another.  Thus, $\varphi$ is conserved in the finite volume method.

\TODO{\textbf{CFL criterion}.  relevant to understand timestep constraints on small cells}

\TODO{\textbf{TVD}}

