WOBBLY_THETA_WOBBLY_THETA_ADVECTION_FINAL_TRACER_FIELD := $(GRAVITY_WAVES_END_TIME)/T
THETA_FINAL_SAMPLE := postProcessing/sets/18000/line_T.xy

# $(1) -- simulation case path
# $(2) -- subproject label
# $(3) -- mesh case path
define WOBBLY_THETA_ADVECTION_TEMPLATE

  $(eval $(call TEST_CASE_TEMPLATE,$(1),,$(3)))
  $(eval $(call PLOT_DIFF_TEMPLATE,$(1),$(2),thetaDiff,$(GRAVITY_WAVES_END_TIME),T,thetaDiff))
  $(eval $(call PLOT_PATCH_DATA_TEMPLATE,$(1),$(2),Uzoom,0))

  .PHONY: $(2) clean-$(2)
  .INTERMEDIATE: $(2).intermediate

  all:: $(2)

  clean:: clean-$(2)

  $(2): $(1)/$(WOBBLY_THETA_ADVECTION_FINAL_TRACER_FIELD)

  clean-$(2):
	$(PY_FOAM_CLEAR_CASE) --processors-remove --additional=0 $(1)
	$(RM) $(2)*.log
	-$(UNLINK) $(1)/$(POLY_MESH_DIR)

  $(1)/$(WOBBLY_THETA_ADVECTION_FINAL_TRACER_FIELD): \
    $(addprefix $(1)/,$(ADVECTION_INITIAL_FIELDS)) \
    $(addprefix $(1)/,$(SYSTEM_FILES))
	$(SCALAR_TRANSPORT_FOAM) -case $(1) > $(2).scalarTransportFoam.log

  $(addprefix $(1)/,$(ADVECTION_INITIAL_FIELDS)): $(2).intermediate

  $(2).intermediate: \
    $(1)/$(POLY_MESH_DIR) \
    $(addprefix $(3)/,$(MESH_FILES)) \
    $(1)/$(INITIAL_CONDITIONS) \
    $(1)/$(TRANSPORT_PROPERTIES) \
    $(1)/$(THETA_INIT)
	$(SET_SCALAR_OVER_OROGRAPHY) -case $(1) > $(2).setScalarOverOrography.initial.log
	$(SET_THETA) -case $(1) > $(2).setTheta.log
	$(MV) $(1)/0/theta $(1)/0/T

  $(1)/$(THETA_INIT): $(COMMON_CASE)/$(THETA_INIT).gravityWaves
	$(CP) $$< $$@

  $(1)/$(GRAVITY_WAVES_END_TIME)/thetaDiff: $(1)/$(WOBBLY_THETA_ADVECTION_FINAL_TRACER_FIELD)

  $(1)/theta.dat: \
    $(1)/$(WOBBLY_THETA_ADVECTION_FINAL_TRACER_FIELD) \
    $(1)/$(SAMPLE_DICT)
	$(SAMPLE) -case $(1) -time $(GRAVITY_WAVES_END_TIME)
	$(CP) $(1)/$(THETA_FINAL_SAMPLE) $$@

  $(1)/$(SAMPLE_DICT): $(COMMON_CASE)/$(SAMPLE_DICT).wobblyThetaAdvection | $(1)/system
	$(LN) -fs $$< $$@

endef

$(eval $(call WOBBLY_THETA_ADVECTION_TEMPLATE,openfoam/cases/wobblyThetaAdvection/btf/schaerExp/cubicUpwindCPCFit,wobblyThetaAdvection-btf-schaerExp-cubicUpwindCPCFit,openfoam/cases/mesh/btf/schaerExp/gravityWaves))
$(eval $(call WOBBLY_THETA_ADVECTION_TEMPLATE,openfoam/cases/wobblyThetaAdvection/snapCol/schaerExp/cubicUpwindCPCFit,wobblyThetaAdvection-snapCol-schaerExp-cubicUpwindCPCFit,openfoam/cases/mesh/snapCol/schaerExp/gravityWaves))
