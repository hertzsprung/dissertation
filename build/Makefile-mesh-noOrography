BLOCK_MESH_DICT_TEMPLATE := blockMeshDict.template

# $(1) -- root directory
# $(2) -- subproject label (e.g. mesh-noOrography)
# $(3) -- boundary-specific case path
# $(4) -- .boundaries file
define BLOCK_MESH_TEMPLATE

  $(eval $(call MESH_TEMPLATE,$(3)))

  .PHONY: $(2) clean-$(2)
  .INTERMEDIATE: $(2).intermediate

  $(2): $(addprefix $(3)/,$(MESH_FILES))

  clean-$(2):
	$(RM) -r $(3)

  $(addprefix $(3)/,$(MESH_FILES)): $(2).intermediate

  $(2).intermediate: \
    $(3)/$(BLOCK_MESH_DICT) \
    $(addprefix $(3)/,$(SYSTEM_FILES))
	$(BLOCK_MESH) -case $(3) > $(2).blockMesh.log

  $(3)/$(BLOCK_MESH_DICT): \
    $(1)/$(BLOCK_MESH_DICT_TEMPLATE) \
    $(4) \
  | $(3)/$(POLY_MESH_DIR)
	$(1)/subst.sh $(4) < $(1)/$(BLOCK_MESH_DICT_TEMPLATE) > $(3)/$(BLOCK_MESH_DICT)

  $(3)/$(POLY_MESH_DIR):
	$(MKDIR) -p $(3)/$(POLY_MESH_DIR)

endef

$(eval $(call BLOCK_MESH_TEMPLATE,openfoam/cases/mesh/noOrography,mesh-noOrography-advection,openfoam/cases/mesh/noOrography/advection,openfoam/cases/mesh/noOrography/advection.boundaries))

$(eval $(call BLOCK_MESH_TEMPLATE,openfoam/cases/mesh/noOrography,mesh-noOrography-resting,openfoam/cases/mesh/noOrography/resting,openfoam/cases/mesh/noOrography/resting.boundaries))

clean:: \
  clean-mesh-noOrography-advection \
  clean-mesh-noOrography-resting
