ADVECTION_END_TIME := 10000
ADVECTION_INITIAL_TRACER_FIELD = 0/T
ADVECTION_FINAL_TRACER_FIELD := $(ADVECTION_END_TIME)/T
ADVECTION_ANALYTIC_TRACER_FIELD := 0/T_analytic # TODO: should really be in $(ADVECTION_END_TIME) directory but don't know how to make OpenFOAM do this
ADVECTION_FINAL_TRACER_DIFF := $(ADVECTION_END_TIME)/T_diff
ADVECTION_TRACER_ERROR := globalSumT_diff.dat
ADVECTION_TRACER_MINMAX := globalSumT.dat
L2_ERROR_STAT := l2error.txt
MIN_STAT := min.txt
MAX_STAT := max.txt

CONTOUR_TIMES = 0 5000 10000

CONTOUR_DATA := $(addsuffix /contour.dat,$(CONTOUR_TIMES))
TRACER_CONTOUR_DICT := $(GMT_DICTS)/tracer-contour
TRACER_CONTOUR_ERROR_DICT := $(GMT_DICTS)/tracer-contour-error

ADVECTION_ANALYTIC_CASE := openfoam/cases/advection/noOrography/vanLeer

# $(1) -- simulation case path
# $(2) -- subproject label
define ADVECTION_DIAGNOSTICS_TEMPLATE

  $(eval $(call PLOT_MULTIDIFF_TEMPLATE,$(1),$(2),tracer-contour-error,$(ADVECTION_END_TIME),T,T_analytic,Tdiff))
  $(eval $(call PLOT_PATCH_DATA_TEMPLATE,$(1),$(2),divU,0))

  .INTERMEDIATE: $(2).contour.intermediate

  $(2)-contour.plt: $(addprefix $(1)/,$(CONTOUR_DATA))

  $(addprefix $(1)/,$(CONTOUR_DATA)): $(2).contour.intermediate

  $(2).contour.intermediate: \
    $(1)/$(ADVECTION_FINAL_TRACER_FIELD) \
    $(1)/$(TRACER_CONTOUR_DICT)
	$(PLOT_PATCH_DATA) -case $(1) -time 0 tracer-contour > $(2).plotPatchData.tracer-contour.0.log
	$(PS_CONTOUR) $(1)/0/T.dat -D -Ccontours.cpt > $(1)/0/contour.dat
	$(PLOT_PATCH_DATA) -case $(1) -time 5000 tracer-contour > $(2).plotPatchData.tracer-contour.5000.log
	$(PS_CONTOUR) $(1)/5000/T.dat -D -Ccontours.cpt > $(1)/5000/contour.dat
	$(PLOT_PATCH_DATA) -case $(1) -time 10000 tracer-contour > $(2).plotPatchData.tracer-contour.10000.log
	$(PS_CONTOUR) $(1)/10000/T.dat -D -Ccontours.cpt > $(1)/10000/contour.dat
	$(SED) -i -re 's/^>.*$$$$//' $(addprefix $(1)/,$(CONTOUR_DATA))

  $(1)/$(TRACER_CONTOUR_DICT): $(COMMON_CASE)/$(TRACER_CONTOUR_DICT) | $(1)/$(GMT_DICTS)
	$(LN) -fs $$< $$@

  $(1)/$(MIN_STAT) $(1)/$(MAX_STAT): $(1)/$(ADVECTION_TRACER_MINMAX)

  $(1)/$(L2_ERROR_STAT): $(1)/$(ADVECTION_TRACER_ERROR)
	tail -n1 $$< | cut -d' ' -f3 > $$@
	sed -i -re 's/(.*)/\\num[round-mode=figures, round-precision=3]{\1}/' $$@

  $(1)/$(MIN_STAT):
	tail -n1 $$< | cut -d' ' -f7 > $$@
	sed -i -re 's/(.*)/\\num[round-mode=figures, round-precision=3]{\1}/' $$@

  $(1)/$(MAX_STAT):
	tail -n1 $$< | cut -d' ' -f8 > $$@
	sed -i -re 's/(.*)/\\num[round-mode=figures, round-precision=3]{\1}/' $$@

  $(1)/0/U.eps: \
    $(1)/$(GMT_DICTS)/U \
    $(1)/0/U
	$(PLOT_PATCH_DATA) -case $(1) -time 0 U > $(2).plotPatchData.U.log

  $(1)/$(GMT_DICTS)/U: \
    $(COMMON_CASE)/$(GMT_DICTS)/U.wobblyTracerAdvection \
  | $(1)/$(GMT_DICTS)
	$(LN) -fs $$< $$@

endef

advection-initial.plt: $(ADVECTION_ANALYTIC_CASE)/0/contour.dat

advection-noOrography-analytic-contour.plt: $(ADVECTION_ANALYTIC_CASE)/0/contour.dat
