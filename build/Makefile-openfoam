export COMMON_CASE := $(abspath openfoam/cases/common)
ifndef PROCESSORS
  # because jasmin doesn't have nproc installed for some reason
  export PROCESSORS := $(shell lscpu | grep "^CPU(s)" | tr -s ' ' | cut -d' ' -f2)
endif
export GMTU := $(abspath openfoam/gmt)

GMT_DICTS := constant/gmtDicts
CONTROL_DICT := system/controlDict
FV_SCHEMES := system/fvSchemes
FV_SOLUTION := system/fvSolution
DECOMPOSE_PAR_DICT := system/decomposeParDict
SAMPLE_DICT := system/sampleDict

ENVIRONMENTAL_PROPERTIES := constant/environmentalProperties

SYSTEM_FILES := \
  $(CONTROL_DICT) \
  $(FV_SCHEMES) \
  $(FV_SOLUTION)

.PHONY: clean-decomposeParDict

$(COMMON_CASE)/$(DECOMPOSE_PAR_DICT): $(COMMON_CASE)/$(DECOMPOSE_PAR_DICT).template
	$(ENV_SUBST) < $@.template > $@

clean:: clean-decomposeParDict

clean-decomposeParDict:
	$(RM) $(COMMON_CASE)/$(DECOMPOSE_PAR_DICT)

# $(1) -- case path
define CASE_TEMPLATE

  $(1)/system:
	$(MKDIR) -p $$@

  $(1)/$(GMT_DICTS):
	$(MKDIR) -p $$@

  $(addprefix $(1)/,$(SYSTEM_FILES)): | $(1)/system

endef

# $(1) -- case path
define DUMMY_SYSTEM_FILES_TEMPLATE

  $(1)/$(CONTROL_DICT):
	$(LN) -fs $(COMMON_CASE)/system/controlDictDummy $$@

  $(1)/$(FV_SCHEMES):
	$(LN) -fs $(COMMON_CASE)/system/fvSchemesDummy $$@

  $(1)/$(FV_SOLUTION):
	$(LN) -fs $(COMMON_CASE)/system/fvSolutionDummy $$@

endef

# $(1) -- case path
# $(2) -- label (e.g. gravityWaves)
# $(3) -- endTime
# $(4) -- timestep
# $(5) -- write interval
define CONTROL_DICT_TEMPLATE

  $(1)/$(CONTROL_DICT): $(COMMON_CASE)/$(CONTROL_DICT).$(2).template
	END_TIME=$(3) TIMESTEP=$(4) WRITE_INTERVAL=$(5) $(ENV_SUBST) < $$< > $$@

endef
